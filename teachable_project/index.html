<div>Teachable Machine Image Model - 画像アップロードで分類</div>

<!-- 画像アップロード用のインプットと分類結果を表示するエリア -->
<input type="file" id="imageUpload" accept="image/*" onchange="loadImage(event)">
<br>
<div id="label-container">分類結果はここに表示されます。</div>
<canvas id="canvas"></canvas>

<!-- TensorFlow.js ライブラリ -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>

<script type="text/javascript">
  let model;
  let canvas, ctx;
  let imageModelURL = 'https://teachablemachine.withgoogle.com/models/O2CXrhSLy/model.json';

  // モデルをロードする
  async function loadModel() {
    console.log("モデルをロード中...");
    model = await tf.loadLayersModel(imageModelURL);
    console.log("モデルが正常にロードされました！");
  }

  // 画像アップロード時に画像を分類するための関数
  function loadImage(event) {
    console.log('画像が選択されました');
    let img = new Image();
    img.onload = function() {
      console.log('画像が読み込まれました！');
      canvas = document.getElementById('canvas');
      ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      console.log('画像がキャンバスに描画されました:', img.width, img.height);
      classifyImage(); // キャンバスを分類
    };
    img.src = URL.createObjectURL(event.target.files[0]);
  }

  // 画像を分類
  async function classifyImage() {
    console.log('分類処理を開始しました');
    const img = tf.browser.fromPixels(canvas);
    const resized = tf.image.resizeBilinear(img, [224, 224]); // モデルに合わせて画像をリサイズ
    const tensor = resized.expandDims(0);
    const predictions = await model.predict(tensor);
    predictions.array().then(scores => {
      console.log('分類結果:', scores);
      displayResult(scores); // 結果を表示する関数を呼び出し
    });
  }

  // 分類結果を表示
  function displayResult(scores) {
    let classNames = ['フォーマル', '水着', 'その他']; // クラス名を定義
    let maxScoreIndex = scores[0].indexOf(Math.max(...scores[0]));
    let result = classNames[maxScoreIndex]; // 最も高いスコアのクラス名を取得
    document.getElementById("label-container").innerHTML = `分類結果: ${result}`;
  }

  // モデルの初期化
  loadModel();
</script>
